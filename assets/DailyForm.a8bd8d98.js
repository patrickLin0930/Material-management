import{z as $,ao as G,ap as J,af as H,a3 as W,r as C,c as X,o as Y,ak as E,a5 as w,ah as _,aa as v,ai as g,j as d,a8 as V,aq as Z,F as O,aj as j,a7 as x,ar as ee,as as I,a6 as te,at as Q,a9 as L,au as M,av as U,aw as ae,R as oe}from"./index.f70666c9.js";import{Q as se}from"./QExpansionItem.ba7b012e.js";import{Q as ne}from"./QSelect.be31338a.js";import{_ as ie}from"./plugin-vue_export-helper.21dcd24c.js";import"./QItem.e2ac683b.js";import"./QItemLabel.81a1b2d6.js";import"./format.d55e7e59.js";function A(l){if(l===!1)return 0;if(l===!0||l===void 0)return 1;const u=parseInt(l,10);return isNaN(u)?0:u}var le=$({name:"close-popup",beforeMount(l,{value:u}){const h={depth:A(u),handler(r){h.depth!==0&&setTimeout(()=>{const D=G(l);D!==void 0&&J(D,r,h.depth)})},handlerKey(r){H(r,13)===!0&&h.handler(r)}};l.__qclosepopup=h,l.addEventListener("click",h.handler),l.addEventListener("keyup",h.handlerKey)},updated(l,{value:u,oldValue:h}){u!==h&&(l.__qclosepopup.depth=A(u))},beforeUnmount(l){const u=l.__qclosepopup;l.removeEventListener("click",u.handler),l.removeEventListener("keyup",u.handlerKey),delete l.__qclosepopup}});const re={name:"DailyForm",setup(){const l=W(),u=new Date().toISOString().split("T")[0],h=C(l.query.date||u),r=C(h.value),D=C(""),N=["\u9032\u8CA8","\u5BB6\u4E2D\u79FB\u81F3\u8ECA\u4E2D","\u8ECA\u4E2D\u79FB\u81F3\u5BB6\u4E2D","\u5DF2\u8CE3\u51FA"],m=C({}),q=C(null),b=C(""),f=C(!1),k=X(()=>{const c={};for(const[y,t]of Object.entries(m.value))c[y]=t.filter(n=>n.name.includes(D.value));return c});async function S(){var e;const c=await E.styles.toArray(),y=await E.dailyForms.get(h.value),t={};c.forEach(o=>{var z,F;const{category:s,name:i,color:a,size:p}=o;t[s]||(t[s]={}),(z=t[s])[i]||(z[i]={}),(F=t[s][i])[a]||(F[a]={}),t[s][i][a][p]={category:s,name:i,color:a,size:p,quantity:0,action:""}}),(e=y==null?void 0:y.records)==null||e.forEach(o=>{var i,a,p;const s=(p=(a=(i=t[o.category])==null?void 0:i[o.name])==null?void 0:a[o.color])==null?void 0:p[o.size];s&&(s.quantity=o.quantity,s.action=o.action)});const n={};for(const[o,s]of Object.entries(t))n[o]=Object.entries(s).map(([i,a])=>({name:i,records:Object.fromEntries(Object.entries(a).map(([p,z])=>[p,Object.values(z)]))}));m.value=n}async function K(){const c=await E.dailyForms.toArray(),y=await E.styles.toArray(),t={};return y.forEach(n=>{var p,z,F,B;const{name:e,color:o,size:s,category:i}=n,a=i||"\u5176\u4ED6\u5546\u54C1";t[a]||(t[a]={home:{},car:{}}),(p=t[a].home)[e]||(p[e]={}),(z=t[a].car)[e]||(z[e]={}),(F=t[a].home[e])[o]||(F[o]={}),(B=t[a].car[e])[o]||(B[o]={}),t[a].home[e][o][s]=0,t[a].car[e][o][s]=0}),c.forEach(n=>{n.records.forEach(e=>{const o=y.find(p=>p.name===e.name&&p.color===e.color&&p.size===e.size),s=(o==null?void 0:o.category)||"\u5176\u4ED6\u5546\u54C1",i=t[s].home[e.name][e.color],a=t[s].car[e.name][e.color];switch(e.action){case"\u9032\u8CA8":i[e.size]+=e.quantity;break;case"\u8ECA\u4E2D\u79FB\u81F3\u5BB6\u4E2D":a[e.size]=Math.max(0,a[e.size]-e.quantity),i[e.size]+=e.quantity;break;case"\u5BB6\u4E2D\u79FB\u81F3\u8ECA\u4E2D":i[e.size]=Math.max(0,i[e.size]-e.quantity),a[e.size]+=e.quantity;break;case"\u5DF2\u8CE3\u51FA":a[e.size]=Math.max(0,a[e.size]-e.quantity);break}})}),t}async function P(c,y){b.value=c;const t=await K(),n=JSON.parse(JSON.stringify(y));n.records=Object.fromEntries(Object.entries(y.records).map(([e,o])=>[e,o.map(s=>({...s,homeStock:t[c].home[y.name][e][s.size]||0,carStock:t[c].car[y.name][e][s.size]||0}))])),q.value=n,f.value=!0}function R(){const c=q.value;for(const[n,e]of Object.entries(c.records))for(const o of e){const{action:s,quantity:i,homeStock:a,carStock:p,size:z}=o;if(s==="\u5BB6\u4E2D\u79FB\u81F3\u8ECA\u4E2D"&&i>a)return I.create({title:"\u5EAB\u5B58\u4E0D\u8DB3",message:`\u6B3E\u865F ${c.name} \u984F\u8272 ${n} \u5C3A\u5BF8 ${z} \u5BB6\u4E2D\u50C5\u5269 ${a} \u4EF6`});if((s==="\u8ECA\u4E2D\u79FB\u81F3\u5BB6\u4E2D"||s==="\u5DF2\u8CE3\u51FA")&&i>p)return I.create({title:"\u5EAB\u5B58\u4E0D\u8DB3",message:`\u6B3E\u865F ${c.name} \u984F\u8272 ${n} \u5C3A\u5BF8 ${z} \u8ECA\u4E0A\u50C5\u5269 ${p} \u4EF6`})}const t=m.value[b.value].findIndex(n=>n.name===c.name);t!==-1&&(m.value[b.value][t]=c),f.value=!1}async function T(){const c=[];Object.values(m.value).forEach(y=>y.forEach(t=>Object.values(t.records).flat().forEach(n=>{n.quantity>0&&n.action&&c.push({category:n.category,name:n.name,size:n.size,color:n.color,quantity:n.quantity,action:n.action})}))),await E.dailyForms.put({date:h.value,records:c}),window.dispatchEvent(new CustomEvent("inventory-updated")),I.create({message:"\u2705 \u8868\u55AE\u5DF2\u5132\u5B58\uFF0C\u5EAB\u5B58\u5DF2\u66F4\u65B0"})}return Y(async()=>{await E.open(),await S()}),{displayDate:r,search:D,actions:N,filteredGrouped:k,openDialog:P,saveDialogData:R,saveForm:T,selectedStyle:q,selectedCategory:b,dialogOpen:f}}},ce={class:"font q-pa-md bg-grey-2"},de={class:"title row items-center justify-between q-mb-md"},ue={style:{"font-size":"4vw","font-weight":"bold"}},me={class:"table column q-gutter-md"},fe={class:"text-weight-bold q-mb-xs",style:{"font-size":"3vw"}},pe={class:"row q-gutter-xs",style:{gap:"2.5vw"}},ye={class:"text-bold",style:{"font-size":"3.5vw"}},ve={style:{"font-size":"3.5vw"}},he={class:"text-blue text-caption",style:{"font-size":"2.75vw","font-weight":"bold"}},we={class:"q-mb-sm text-primary",style:{"margin-bottom":"1.2vh","font-size":"4vw"}},be={class:"column",style:{padding:"0 0.5vw 1.5vw 2.5vw"}},_e={class:"text-bold",style:{width:"20vw","font-size":"4vw"}},ge={class:"text-caption",style:{"font-size":"2.5vw",color:"#888"}},ze={class:"row items-center q-gutter-sm",style:{"padding-bottom":"0.5vh"}},qe={style:{"min-width":"10vw","text-align":"center","font-size":"4vw","font-weight":"bold"}};function xe(l,u,h,r,D,N){return w(),_("div",ce,[v("div",de,[v("div",ue," \u6BCF\u65E5\u8CA8\u7269\u6D41\u52D5\u8868\u55AE\uFF08"+g(r.displayDate)+"\uFF09 ",1),d(V,{label:"\u5132\u5B58\u4ECA\u5929\u8868\u55AE",color:"primary",class:"q-px-md q-py-sm",onClick:r.saveForm,style:{"font-size":"3.5vw","font-weight":"bold"}},null,8,["onClick"])]),d(Z,{modelValue:r.search,"onUpdate:modelValue":u[0]||(u[0]=m=>r.search=m),label:"\u641C\u5C0B\u6B3E\u865F",dense:"",filled:"",debounce:"300",class:"q-mb-md input"},null,8,["modelValue"]),v("div",me,[(w(!0),_(O,null,j(r.filteredGrouped,(m,q)=>(w(),te(se,{key:q,label:q,"expand-separator":"","header-class":"bg-blue-grey-1 text-blue text-weight-bold",style:{"font-size":"3.5vw"}},{default:x(()=>[(w(!0),_(O,null,j(m,b=>(w(),_("div",{key:b.name,class:"full-width"},[d(U,{flat:"",bordered:"",class:"q-mb-md cursor-pointer",onClick:f=>r.openDialog(q,b)},{default:x(()=>[d(Q,{class:"bg-primary text-white text-weight-bold",style:{"font-size":"3vw"}},{default:x(()=>[L(" \u6B3E\u865F\uFF1A"+g(b.name),1)]),_:2},1024),d(M),d(Q,{class:"q-pa-sm bg-grey-1"},{default:x(()=>[(w(!0),_(O,null,j(b.records,(f,k)=>(w(),_("div",{key:k,class:"q-mb-sm q-pa-sm bordered bg-white shadow-1",style:{"border-radius":"6px"}},[v("div",fe," \u984F\u8272\uFF1A"+g(k),1),v("div",pe,[(w(!0),_(O,null,j(f,S=>(w(),_("div",{key:S.size,class:"text-center bg-grey-2 bordered",style:{"min-width":"20vw",padding:"6px","border-radius":"4px","font-size":"16px"}},[v("div",ye,g(S.size),1),v("div",ve,g(S.quantity),1),v("div",he,g(S.action||"-"),1)]))),128))])]))),128))]),_:2},1024)]),_:2},1032,["onClick"])]))),128))]),_:2},1032,["label"]))),128))]),d(ee,{modelValue:r.dialogOpen,"onUpdate:modelValue":u[1]||(u[1]=m=>r.dialogOpen=m),persistent:""},{default:x(()=>[d(U,{style:{"min-width":"95vw","max-width":"700px"}},{default:x(()=>[d(Q,{style:{"font-size":"4.5vw","font-weight":"bold"}},{default:x(()=>{var m;return[L(" \u7DE8\u8F2F\u6B3E\u865F\uFF1A"+g((m=r.selectedStyle)==null?void 0:m.name),1)]}),_:1}),d(M),d(Q,{class:"bg-grey-1"},{default:x(()=>{var m;return[(w(!0),_(O,null,j((m=r.selectedStyle)==null?void 0:m.records,(q,b)=>(w(),_("div",{key:b,class:"q-mb-md bordered rounded bg-white q-pa-sm shadow-1"},[v("div",we," \u984F\u8272\uFF1A"+g(b),1),v("div",be,[(w(!0),_(O,null,j(q,f=>(w(),_("div",{key:f.size,class:"row items-center justify-between q-gutter-md bg-grey-2 bordered q-pa-sm",style:{"border-radius":"6px","font-size":"3vw"}},[v("div",_e,g(f.size),1),v("div",ge," \u5BB6\u4E2D: "+g(f.homeStock)+" / \u8ECA\u4E2D: "+g(f.carStock),1),v("div",ze,[d(V,{round:"",dense:"",icon:"remove",color:"grey",size:"lg",onClick:k=>f.quantity=Math.max(0,f.quantity-1)},null,8,["onClick"]),v("div",qe,g(f.quantity),1),d(V,{round:"",dense:"",icon:"add",color:"primary",size:"lg",onClick:k=>f.quantity++},null,8,["onClick"])]),d(ne,{dense:"",outlined:"",options:r.actions,modelValue:f.action,"onUpdate:modelValue":k=>f.action=k,"emit-value":"","map-options":"",style:{"min-width":"25vw","font-size":"5vw"}},null,8,["options","modelValue","onUpdate:modelValue"])]))),128))])]))),128))]}),_:1}),d(M),d(ae,{align:"right",style:{height:"5vh","margin-bottom":"1vh",gap:"2vw"}},{default:x(()=>[d(V,{flat:"",label:"\u5132\u5B58",color:"primary",onClick:r.saveDialogData,style:{width:"25vw","font-size":"4vw","background-color":"#f0f8ff"}},null,8,["onClick"]),oe(d(V,{flat:"",label:"\u95DC\u9589",color:"grey",style:{width:"25vw","font-size":"4vw","background-color":"#f0f8ff"}},null,512),[[le]])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}var Fe=ie(re,[["render",xe],["__scopeId","data-v-36f5a925"]]);export{Fe as default};
